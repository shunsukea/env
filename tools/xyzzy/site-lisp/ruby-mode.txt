ruby-mode for xyzzy 改変版 100704

                            Yukimi Sake  yukimi_sake@mbi.nifty.com
                           http://homepage3.nifty.com/Yukimi_Sake/

服部さんのオリジナルを改変したruby-modeです。

最初にお断りしておきますが、この版の責任は全て私、雪見酒にあります。
不具合等の報告は全て標記のメールアドレスまでお願いします。
くれぐれも服部さんに直接メールを送ってご迷惑のかかることがないように
ご注意ください。

また、あなたがこのソフトウエアを使用したことによって蒙った不利益につ
いて、私も服部さんも、その他誰も、いかなる補償もしくは、損害賠償、そ
の他あらゆる賠償行為の責務を負わないことを表明しておきます。あくまで
も自己責任でご使用ください。

さて、堅い話はこれくらいにしておいて、服部さんのを以下のような仕様に
改変してあります。
(オリジナルのURLはこちら http://www7a.biglobe.ne.jp/~hat/ )

ruby-mode.l単体で以下のことができます。

1.RDコメントにも対応したキーワードの色つけ、ボールド表示

  キーワードの色つけだけはxyzzyの組み込み機能をを使用していますが、
  rdや、コメント、文字列などの色つけなどは自前でシンタックスを解析
  しています。で、予約語はボールドにしています。
  この版からヒアドキュメント、%記法に対応しました。つまり
  全てのリテラルと式展開をパースしています。ただし Rubyは動的な言語
  であるため、実行時以外は完全なパースができません。特にローカル変数
  と、レシーバと引数括弧を両方省略したメソッドは、バッファ上では区別
  をつけるのが大変困難です。実用上支障のないレベルまでは作りこんだつ
  もりですが、不具合のあるときはエスケープ文字 '\'や () を適宜使用し
  てください。

2.ESC-]による文括弧の検索

  全リテラルをパースできるようになったので、この機能を追加しました。
  ESC-] で class module def if などとそれに対応した end の間をキャレ
  ットが往復します。{}も正しく対応します。なお、()[]の検索はxyzzyの
  オリジナルをそのまま使用していますので間に挟まれる文によっては正し
  く往復しないことがあります。
  関数は ruby-electric-goto-parenthesis です。

3.オートインデント

  これも自前でシンタックスを解析していますので、修飾子や一行中に
  複数のインデント対象構文があっても正しくインデントします。です
  ので[TAB]だけでなく[ENTER]でもオートインデントするようにしまし
  た。また、前バージョンのようなリテラルによる制限はありません。
  なお、リテラル内は前行のインデントラベルに合わせるシンプルイン
  デントにしてあります。一般部はruby-toggle-indent-modeでオート
  インデントとシンプルインデントが切り替わります。インデントなし
  のモードはありません。
  *ruby-indent-column* は廃止しました。タブ幅は(tab-columns)で計算
  します。つまり、共通設定のタブ幅に追従します。
  タブ文字とスペースの切り替えは*ruby-indent-with-spaces*で設定し
  ます。デフォルトはtです。

4.F1でHTMLHelp版のRubyリファレンスマニュアルが開くようにした。

  http://www.ruby-lang.org/ja/documentation/からchm版のを取ってきて、
  rubymanjp.chm とリネームしてxyzzy\etc\に置いてください。
  原作のスクリプトは、服部さんのlisp用reference.lです。

5.スクリプトの実行

  服部さんのオリジナルでは別ファイルでしたが、ruby-mode.lに取り
  込みました。
  即時実行と、引数付の二種類で、実行時の標準出力はRDE同様リアル
  タイムにテンポラリバッファ(*cmd*という名前)に表示されます。
  なお、保存したファイルが対象ですので、実行前に保存してくださ
  い。テンポラリファイルを使うか、自動保存して実行するかは
  グローバル変数 *ruby-save-bufer-before-run* を変更してください。
  デフォルトはtです。

6.オートコンプリージョン

  SHIFT+SPCでxyzzy/etc/にあるキーワードファイルRubyに登録されて
  いる単語は補完することができます。
  （キーバインド以外は、服部さんのオリジナルのままです）

7.GATESキーマップの追加

  Windows標準のキーバインドでなきゃやだ、という向きには
  (load-library "Gates")
  した場合は実行関係と関数一覧はファンクションキーに割り付けまし
  た。（xyzzyの機能が制限されるので、あまりお勧めしませんが）

8.関数一覧

  服部さんのオリジナルのままです。

9.ruby-interaction-mode

  irbを利用したインタラクション（対話）マイナーモードです。
  M-x ruby-interaction-mode またはC-c i (GatesではC-F5)でirbが
  起動−トグルします。
  で、C-jでバッファ上のスクリプトをirbに送りつけ、結果を*Result*
  バッファに表示します。
  送り方は、"end"のある行では、トップレベルの定義をそっくり送り
  つけようとします。トップレベルの"end"でない場合はその旨メッセ
  ージを出して、何もしません。
  "end"でない行では、一行をirbに送り、irbが実行します。
  高速なキーリピートで、C-jを送りつづけたり、変なスクリプトを送
  れば、irbが死にます。(汗)
  この場合は、あわてずに、C-c i (C-F5)を2回押してください。

あ、実行系のコマンドやインタラクションモードのためには、予め
ruby.exe へのパスを通しておいてください。
Windows9XならAUTOEXEC.BATに、NT,2000,XPなら環境変数へ直接ですね。

ざっとこんなところですが、肝心の速度はパース量を増やしたことで
さらに遅くなりました。でも、パースする機会を減らす工夫をしてあ
りますので、いまどきのマシンなら3千行くらいまではそれ程ストレス
なく使用できるでしょう。

さて、インストール方法ですが、2種類です、と書こうとしましたが、
すみませんNetInstallerは未対応です。近いうちに対応します。

1. NetInstallerを使用する。<<すみません、未対応です>>

  NetInstallerについては
  http://xyzzy.s53.xrea.com/wiki/index.php?QuickTour%2Fext%2FNetInstaller
  を参照してください。設定まで自動でやってくれますので、
  site-lisp\ruby-hilite.lだけを自分の好みに編集してください。この
  ファイルはインストールのたびに上書きされますので、バックアップを
  取っておいた方がよいでしょう。
  
    
2. rbmode100630.lzhを展開して自分でインストールする。

  rbmode100630.lzh を展開して、ruby-mode.l、ruby-mode.lc
  とruby-hilite.lをxyzzy\site-lisp\に置いてください。
  コンパイル済みのruby-mode.lcを同梱してありますのでソースを変更し
  ない限りバイトコンパイルの必要はありません。

  なお、バイトコンパイルの手順は
  [ESC-x]
  byte-compile-file [ENTER]
  /xyzzy/site-lisp/ruby-mode.l [ENTER]
  これでディレクトリにruby-mode.lcができます。
  これをやらないと遅くて到底使い物になりません。

  ruby-hilite.lは強調表示の設定ファイルですのでバイトコンパイルの
  必要はありません。こちらをいじると文字列や、コメントや、RDなどの
  色使いを変えることができますので、自分の好みに変更してください。
  なお、以前のruby-hilite.lとはボールドの付け方を変えていますので、
  注意してください。以前のを別名でバックアップしておいて、新しい
  ruby-hilite.lの色設定の部分を書き直すようにしてください。

  キーワードファイル"Ruby"はxyzzy\etc\に置いてください。服部さんの
  と違って、必要最低限のキーワードしか作っていませんので、必要に応
  じて追加するか、服部さんのオリジナルを使ってください。

  あとは.xyzzy かsite-init.lに以下のスクリプトを追加してください。
  なお、オリジナルのruby.lとの共存はできません。先にオリジナルを
  インストールしてある場合は該当行をコメントアウトしてください。

  ==以下サンプル==

  ;(load-library "Gates"); Gates が好きならファイルの先頭に
  (load-library "ruby-mode")
  (push '("\\.rb$" . ruby-mode) *auto-mode-alist*)


謝辞

すばらしい、エディタのようなもの(笑)を開発、公開してくださった
亀井哲也さん、ruby-modeはじめ数々のスクリプト公開や、xyzzyの普及
に貢献してくださっている服部昌司さん、そしてxyzzyコミュニティの
皆さん、どうもありがとうございます。

                                               2010/06/30 雪見酒

2010/07/04  [EOF]直前ではパースをサボっていたのを修正。
            Netinstallerに対応。

2010/06/25  ヒアドキュメントと%リテラルに対応。4年前(汗)に平岡さん
            よりご指摘頂いていた式展開中の表示のバグなども修正。
            文括弧のジャンプ機能を追加。
            post-buffer-modifyed-hook の処理で、それ以前のマッチデ
            ータを壊さないように修正。

2004/04/08  replace系コマンドがおかしくなっていたのを修正。
            ruby-refreshコマンドを追加。query-replaeをキャンセル
            した場合など、ruby-modeがリフレッシュをサボった場合
            の手動リフレッシュ用。C-c r   GatesではS-F12

2004/03/23  run-scriptで、"Program Files"のようにスペースを含む
            パスにスクリプトファイルがあると、エラーになったのを
            修正。

2004/03/08  when 直後の正規表現を認識しなかったのを修正。

2004/02/15  変更行で複数のコメント文字があると、その間の色がコメ
            ント色にならなかったのを修正。
            run-scriptで、カレントディレクトリをちゃんとセットし
            ていなかったのを修正。

2004/02/05  シンボルの正規表現がおかしかったのを修正(ruby-hilite)
            run-scriptで、VisualuRubyのようにプロセスが長時間走る
            場合、xyzzyがプロセス終了を検出できず、ハングアップ状
            態になってしまう場合があったのを修正したつもり。
            同、*cmd*バッファが空の場合、閉じるようにした。

2004/01/27  式展開でない"}"が書き込み行で文字列色になっていたのを
            修正

2004/01/25  正規表現、?リテラルに対応

2004/01/21  rby-interaction-mode で、irbの起動方法を変更
            ActiveScriptRuby以外でも起動するようにした
            同、irbのリザルトにプロンプト"==>"をつけた

2004/01/12  式展開に対応

2004/01/05  オートインデントでエスケープ付のクォーテーション文字
            の扱いをミスっていたのを修正

2004/01/04  $' $" $` の判定をミスっていたのを修正

2004/01/03  ruby-interaction-mode を追加
            ruby-mode以外でもpost-buffer-modified-hook が実行され
            ていたのを修正
            "="の直後のキーワードの認識がおかしかったのを修正

2003/12/30  改変版リリース

残件

・高速化。パースチャンスはまだ減らせる。
・インプットヘルパ。

